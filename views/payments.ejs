<% layout('layouts/boilerplate') %>

    <!-- Ambient Background -->
    <div class="payment-wrapper">
        <div class="gold-aura"></div>

        <div class="luxury-podium">

            <!-- LEFT: The Experience Summary -->
            <div class="details-pane">
                <div class="brand-title">
                    Wanderly <div class="brand-lines"></div>
                </div>

                <div class="stay-summary">
                    <h1 class="stay-title">
                        <%= listing.title %>
                    </h1>
                    <p class="stay-location">
                        <%= listing.location %>, <%= listing.country %>
                    </p>
                </div>

                <div class="invoice-rows">
                    <div class="row">
                        <span>Rate per Night</span>
                        <span>₹<%= listing.price.toLocaleString("en-IN") %></span>
                    </div>
                    <div class="row">
                        <span>Taxes & Fees</span>
                        <span>₹<%= (listing.price * 0.18).toLocaleString("en-IN", {maximumFractionDigits: 0}) %></span>
                    </div>
                    <!-- Dynamic Invoice ID Generation for visual flair -->
                    <div class="row">
                        <span>Invoice Ref</span>
                        <span style="font-family: 'Courier New', monospace;">#INV-<%= Math.floor(1000 + Math.random() *
                                9000) %></span>
                    </div>

                    <div class="total-row">
                        <span class="total-label">Total to Pay</span>
                        <span class="total-value">₹<%= (listing.price * 1.18).toLocaleString("en-IN",
                                {maximumFractionDigits: 0}) %></span>
                    </div>
                </div>
            </div>

            <!-- RIGHT: The Interactive Card Stage -->
            <div class="card-stage">
                <div class="mesh-bg"></div>

                <!-- The 3D Wandery Black Card -->
                <div class="credit-card" id="tiltCard">
                    <div class="chip"></div>
                    <div class="wifi-icon"><i class="fa-solid fa-wifi"></i></div>
                    <div class="card-logo">WANDERLY ELITE</div>
                    <div class="card-number">**** **** **** 4242</div>

                    <div class="card-holder">
                        <span class="holder-label">Card Holder</span>
                        <span class="holder-name">
                            <%= user.username %>
                        </span>
                    </div>

                    <div class="card-expiry">
                        <span class="holder-label">Expires</span>
                        <span class="holder-name">∞/∞</span>
                    </div>
                </div>

                <div class="pay-btn-container">
                    <button id="rzp-button">
                        Complete Payment
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // 3D Tilt Effect for the Card
            const card = document.getElementById('tiltCard');
            const container = document.querySelector('.card-stage');

            container.addEventListener('mousemove', (e) => {
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const centerX = rect.width / 2;
                const centerY = rect.height / 2;

                const rotateX = ((y - centerY) / centerY) * -10; // Max tilt 10deg
                const rotateY = ((x - centerX) / centerX) * 10;

                card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });

            container.addEventListener('mouseleave', () => {
                card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg)`;
            });


            // Razorpay Logic
            const razorpayKeyId = "<%= razorpayKeyId %>";
            const razorpayUser = {
                name: "<%= user.username %>",
                email: "<%= user.email %>"
            };
            const payBtn = document.getElementById("rzp-button");

            if (payBtn) {
                payBtn.onclick = async function () {
                    const listingId = window.location.pathname.split("/")[2];
                    try {
                        const res = await fetch(`/listings/${listingId}/book/create-order`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" }
                        });
                        const orderData = await res.json();

                        const options = {
                            key: razorpayKeyId,
                            amount: orderData.amount,
                            currency: orderData.currency,
                            name: "Wanderly Experience",
                            description: "Payment for " + "<%= listing.title %>",
                            order_id: orderData.id,
                            handler: function (response) {
                                const paymentData = {
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_signature: response.razorpay_signature,
                                    listingId: "<%= listing._id %>"
                                }
                                // sending the payment data to the verification route to check if the payment is valid and successful or not
                                fetch("/verify-payment", {
                                    method: "POST",
                                    body: JSON.stringify(paymentData),
                                    headers: { "Content-Type": "application/json" }
                                })
                                    .then(res => res.blob())
                                    .then(blob => {
                                        const url = window.URL.createObjectURL(blob)
                                        const a = document.createElement("a") // creating an anchor tag element
                                        a.href = url
                                        a.download = `receipt_${paymentData.razorpay_payment_id}.pdf`
                                        a.click(); // simulating a click on the anchor tag to hit the url to get the pdf
                                        console.log("pdf downloaded successfully...")
                                        window.URL.revokeObjectURL(url)
                                    })
                                window.location.href = "/listings"; // take back to the listings page
                            },
                            prefill: {
                                name: razorpayUser.name,
                                email: razorpayUser.email
                            },
                            theme: {
                                color: "#D4AF37" // Matches Gold theme
                            }
                        };
                        const rzp = new Razorpay(options);
                        rzp.open();
                    } catch (err) {
                        console.error("Order creation failed:", err);
                        alert("Unable to initiate payment. Please try again.");
                    }
                };
            }
        });
    </script>